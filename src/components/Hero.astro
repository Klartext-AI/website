---
interface Props {
  lang?: 'de' | 'en';
}

const { lang = 'de' } = Astro.props;

const content = {
  de: {
    main: "We don't build chatbots.",
    subtitle: "Dein Partner für individuelle KI-Lösungen mit messbarem Mehrwert.",
    scrollHint: "Scroll"
  },
  en: {
    main: "We don't build chatbots.",
    subtitle: "Your partner for tailored AI solutions that deliver tangible results.",
    scrollHint: "Scroll"
  }
};

const text = content[lang];
const BASE = import.meta.env.BASE_URL;
---

<section class="hero">
  <div class="hero-logo-wrapper">
    <img
      src={`${BASE}LOGO_transparent.png`}
      alt="Klartext AI"
      class="hero-logo"
      width="300"
      height="auto"
    />
  </div>

  <div class="hero-content">
    <h1 class="hero-title">
      <span class="hero-main" data-text={text.main}></span>
    </h1>
    <p class="hero-subtitle fade-subtitle" data-text={text.subtitle}></p>
  </div>

  <div class="scroll-hint">
    <span>{text.scrollHint}</span>
    <svg class="scroll-arrow" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M12 5v14M5 12l7 7 7-7"/>
    </svg>
  </div>
</section>

<style>
  :root {
    /* Default duration; overridden per-element via JS to match typing length */
    --border-fade-duration: 0.8s;
  }

  .hero {
    min-height: 100vh; /* fallback */
    min-height: 100dvh; /* fill visible viewport on mobile */
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    position: relative;
    padding: var(--space-md);
    border-bottom: 1px solid transparent; /* prevent next section margin-collapsing into hero */
  }

  .hero-logo-wrapper {
    position: absolute;
    top: 5rem; /* Increased from var(--space-md) to avoid navigation overlap */
    left: 50%;
    transform: translateX(-50%);
    opacity: 0;
    animation: logoFadeIn 1.5s ease 0.5s forwards;
    z-index: 100; /* Below navigation but above other content */
  }

  @keyframes logoFadeIn {
    0% {
      opacity: 0;
      transform: translateX(-50%) translateY(-20px);
    }
    100% {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }
  }

  .hero-logo {
    max-width: 250px;
    width: 100%;
    height: auto;
    filter: drop-shadow(0 4px 12px rgba(36, 121, 190, 0.15));
  }

  .hero-content {
    text-align: center;
    max-width: 1000px;
    margin-top: var(--space-2xl);
  }

  .hero-title {
    margin-bottom: var(--space-md);
    display: flex;
    justify-content: center;
    align-items: center;
  }

  .hero-main {
    display: inline-block;
    font-size: 2.7rem;
    font-weight: 300;
    letter-spacing: 0.005em;
    opacity: 0;
    border: 1px solid var(--color-text-body);
    padding: var(--space-sm) var(--space-lg);
    border-radius: 45px;
    white-space: nowrap;
    width: clamp(400px, 70vw, 2000px);
    text-align: center;
    transition: border-color var(--border-fade-duration, 0.8s) ease;
  }

  .hero-main.typing {
    opacity: 1;
  }

  /* Show bordered pill (without caret) before typing */
  .hero-main.pretyping {
    opacity: 1;
  }

  .hero-main.border-fade {
    border-color: transparent;
  }

  .hero-main::after {
    content: '|';
    display: inline-block;
    width: 0.6ch; /* Reserve space so removing caret doesn't shift text */
    animation: blink 1s infinite;
    margin-left: 4px;
    transition: opacity 0.4s ease; /* allow fade-in */
  }

  /* Hide caret during pretyping */
  .hero-main.pretyping::after {
    opacity: 0;
    animation: none;
  }
  /* Fade in caret while still in pretyping state */
  .hero-main.pretyping.caret-visible::after {
    opacity: 1;
  }

  .hero-main.typing-complete::after {
    /* Keep the caret space, fade it out smoothly to avoid re-centering */
    content: '|';
    animation: none;
    opacity: 0;
    transition: opacity 0.3s ease 0.15s;
  }

  @keyframes blink {
    0%, 49% { opacity: 1; }
    50%, 100% { opacity: 0; }
  }

  .hero-subtitle {
    font-size: 1.6rem;
    font-weight: 300;
    color: var(--color-blue);
    margin-bottom: var(--space-lg);
    opacity: 0;
    min-height: 2.4rem;
    margin-left: auto;
    margin-right: auto;
    text-align: center;
    transform: translateY(10px);
    transition: opacity 1.8s cubic-bezier(0.22, 1, 0.36, 1), transform 1.8s cubic-bezier(0.22, 1, 0.36, 1);
    will-change: opacity, transform;
    white-space: normal; /* Allow wrapping if needed; height stabilized by preloading text */
  }

  .hero-subtitle.visible {
    opacity: 1;
    transform: translateY(0);
  }

  .scroll-hint {
    position: absolute;
    bottom: var(--space-lg);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: var(--space-xs);
    color: var(--color-text-muted);
    font-size: 0.875rem;
    opacity: 0;
    animation: fadeIn 1s ease 3s forwards;
  }

  @keyframes fadeIn {
    to { opacity: 1; }
  }

  .scroll-arrow {
    animation: bounce 2s infinite;
  }

  @keyframes bounce {
    0%, 20%, 50%, 80%, 100% {
      transform: translateY(0);
    }
    40% {
      transform: translateY(-10px);
    }
    60% {
      transform: translateY(-5px);
    }
  }

  @media (max-width: 768px) {
    .hero {
      min-height: 100vh; /* fallback */
      min-height: 100dvh; /* full screen on mobile */
      padding: var(--space-sm);
    }

    .hero-logo-wrapper {
      top: 4.5rem; /* Adjusted for mobile to avoid navigation overlap */
    }

    .hero-logo {
      max-width: 160px;
    }

    .hero-content {
      margin-top: var(--space-xl);
      width: 100%;
      padding: 0 var(--space-sm);
    }

    .hero-title {
      width: 100%;
      display: flex;
      justify-content: center;
    }

    .hero-subtitle {
      font-size: 1.2rem;
    }

    .hero-main {
      font-size: 1.6rem;
      padding: var(--space-xs) var(--space-md);
      border-radius: 35px;
      max-width: 95vw;
      width: 80vw;
    }
  }

  @media (max-width: 480px) {
    .hero-main {
      font-size: 1.3rem;
      padding: 0.5rem 1rem;
      border-radius: 30px;
    }

    .hero-subtitle {
      font-size: 1.1rem;
    }
  }
</style>

<script>
  // Typing animation for hero text
  function typeText(element: HTMLElement, text: string, speed: number = 80): Promise<void> {
    return new Promise((resolve) => {
      let index = 0;
      element.classList.add('typing');

      const typeChar = () => {
        if (index < text.length) {
          element.textContent = text.substring(0, index + 1);
          index++;
          setTimeout(typeChar, speed);
        } else {
          element.classList.add('typing-complete');
          resolve();
        }
      };

      typeChar();
    });
  }

  // Initialize hero animations
  document.addEventListener('DOMContentLoaded', async () => {
    const heroMain = document.querySelector('.hero-main') as HTMLElement;
    const heroSubtitle = document.querySelector('.hero-subtitle') as HTMLElement;

    if (heroMain && heroSubtitle) {
      const mainText = heroMain.getAttribute('data-text') || '';

      // Preload subtitle text immediately (kept hidden) to stabilize layout height
      heroSubtitle.textContent = heroSubtitle.getAttribute('data-text') || '';

      // Step 1: show bordered pill immediately without caret
      heroMain.classList.add('pretyping');

      const typingSpeed = 95;
      const typingDuration = mainText.length * typingSpeed;

      // Step 2: after 0.5s fade in caret (still not typing)
      await new Promise(resolve => setTimeout(resolve, 500));
      heroMain.classList.add('caret-visible');

      // Step 3: after another 0.5s start typing
      await new Promise(resolve => setTimeout(resolve, 500));
      heroMain.classList.add('typing');
      heroMain.classList.remove('pretyping', 'caret-visible');

      // Border fade: start 1s after typing begins, finish exactly when typing completes
      const fadeDelay = 1000; // ms after typing start
      setTimeout(() => {
        const remaining = Math.max(typingDuration - fadeDelay, 0);
        heroMain.style.setProperty('--border-fade-duration', `${remaining}ms`);
        heroMain.classList.add('border-fade');
      }, fadeDelay);

      await typeText(heroMain, mainText, typingSpeed);

      // Reveal subtitle after typing completes
      await new Promise(resolve => setTimeout(resolve, 650));
      heroSubtitle.classList.add('visible');
    }
  });
</script>
