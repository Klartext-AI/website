---
import Icon from './Icon.astro';


interface Props {
  lang?: 'de' | 'en';
}

const { lang = 'de' } = Astro.props;

const BASE = import.meta.env.BASE_URL;

const content = {
  de: {
    headline: "Unser Kompass.",
    valuesButton: "Unsere Werte entdecken",
    cards: [
      {
        title: "Verantwortung",
        short: "Fortschritt, der alle mitnimmt.",
        full:"„Verantwortung bedeutet, Technologie im Sinne des Gemeinwohls zu gestalten. Und dabei die gesamte Gesellschaft auf diesem Weg mitzunehmen.” – Ruben",
        link: "values-verantwortung"
      },
      {
        title: "Thought Leadership",
        short: "Kompetenz mit Weitblick.",
        full: "„Thought Leadership heißt für uns, technologische Entwicklungen nicht nur zu verfolgen, sondern sie aktiv mitzugestalten: durch Forschung, Austausch und Lösungen, die echten Impact liefern.“ – Daniel",
        link: "values-thought-leadership"
      },
      {
        title: "Fachliche Exzellenz",
        short: "Technologie auf höchstem Niveau.",
        full:"„Gute KI ist kein Zufall, sondern das Ergebnis klarer Prinzipien, dynamischer Prozesse und konsequenter Evaluierung.“ – Felix",
        link: "values-fachliche-exzellenz"
      }
    ]
  },
  en: {
    headline: "What guides our work.",
    valuesButton: "Explore our values",
    cards : [
      {
        title: "Responsibility",
        short: "Progress that includes everyone.",
        full:
          "“Responsibility means shaping technology for the common good. And including society along every step of the way.” – Ruben",
        link: "en/values-responsibility"
      },
      {
        title: "Thought Leadership",
        short: "Knowledge with depth and direction.",
        full:
          "“Innovation emerges where research, community, and practice meet. When we collectively define what responsible AI should look like tomorrow.” – Daniel",
        link: "en/vlaues-thought-leadership-en"
      },
      {
        title: "Excellence through Technology",
        short: "Engineering at the highest level.",
        full:
          "“Great AI is never accidental. It is the result of clear principles, adaptive processes, and rigorous evaluation.” – Felix",
        link: "en/values-excellence-technology"
      }
    ]
  }
};

const text = content[lang];
const valuesHref = lang === 'de' ? `${BASE}values` : `${BASE}en/values`;
---

<section id="value-proposition" class="value-prop section">
  <div class="container">
    <div class="section-header fade-in text-center">
      <h2 class="value-prop-headline">{text.headline}</h2>
    </div>

    <div class="cards-grid">
      {text.cards.map((card, index) => (
        // outer element is now a div with data-href so we can control navigation on mobile vs desktop
        <div role="button" tabindex="0" data-href={`${BASE}${card.link}`} class="glass-card value-card fade-in" style={`animation-delay: ${index * 0.2}s`}>
          <div class="card-header">
            <div class="card-icon">
              {index === 0 && (
                <Icon name="users" size={40} />
              )}
              {index === 1 && (
                <Icon name="rocket" size={40} />
              )}
              {index === 2 && (
                <Icon name="graduation" size={40} />
              )}
            </div>
            <h3 class="card-title">{card.title}</h3>
          </div>
          <p class="card-short">{card.short}</p>
          <p class="card-full">{card.full}</p>
          <div class="card-link">
            {/* inner CTA is the only real link that should always navigate */}
            <a class="card-cta" href={`${BASE}${card.link}`}>{lang === 'de' ? 'Mehr erfahren' : 'Learn how'}
              <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 12l4-4-4-4"/>
              </svg>
            </a>
          </div>
        </div>
      ))}
    </div>

    <div class="values-button-wrapper text-center fade-in">
      <a href={valuesHref} class="btn btn-secondary value-cta-button">
        {text.valuesButton}
      </a>
    </div>
  </div>

  <!-- Client-side script to toggle expanded state on mobile and navigate on desktop -->
  <script>
    (function(){
      const mq = window.matchMedia('(max-width: 768px)');
      const processedCards = new WeakSet(); // track cards we've wired listeners for

      function setupCards(){
        const cards = document.querySelectorAll('.value-card');
        cards.forEach(cardEl => {
          const card = cardEl; // Element reference
          // Ensure we only attach listeners once
          if (processedCards.has(card)) return;
          processedCards.add(card);

          const href = (card instanceof HTMLElement && card.dataset) ? card.dataset.href : undefined;

          card.addEventListener('click', (e) => {
            const target = e.target instanceof HTMLElement ? e.target : null;
            if (target && target.closest('.card-cta')) return; // let link handle navigation

            if (mq.matches) {
              // mobile: expand/collapse only
              e.preventDefault();
              if (card instanceof HTMLElement) card.classList.toggle('expanded');
            } else {
              // desktop: navigate
              if (href) window.location.href = href;
            }
          });

          card.addEventListener('keydown', (e) => {
            const key = (e instanceof KeyboardEvent) ? e.key : '';
            if (key === 'Enter' || key === ' ') {
              e.preventDefault();
              if (mq.matches) {
                if (card instanceof HTMLElement) card.classList.toggle('expanded');
              } else if (href) {
                window.location.href = href;
              }
            }
          });
        });
      }

      if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', setupCards);
      else setupCards();

      const handleViewportChange = (ev) => {
        // When leaving mobile, collapse all expanded cards
        if (!ev.matches) {
          document.querySelectorAll('.value-card.expanded').forEach(expEl => {
            if (expEl instanceof HTMLElement) expEl.classList.remove('expanded');
          });
        }
      };

      try { mq.addEventListener('change', handleViewportChange); } catch { mq.addListener(handleViewportChange); }
    })();
  </script>
</section>

<style>
  .value-prop {
    background: transparent;
  }

  .value-prop-headline {
    font-size: var(--font-size-h3);
    font-weight: 300;
    max-width: 900px;
    margin: 0 auto;
    line-height: 1.5;
  }

  .cards-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: var(--space-md);
    margin-top: var(--space-lg);
  }

  .value-card {
    position: relative;
    cursor: pointer;
    overflow: hidden;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    text-decoration: none;
    display: block;
  }

  .card-header {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
  }

  .card-icon {
    margin: 0 auto var(--space-sm);
    color: var(--color-blue);
    display: flex;
    justify-content: center;
    align-items: center;
    transition: transform 0.4s ease;
    flex-shrink: 0;
  }

  .card-title {
    font-size: 1.5rem;
    font-weight: 500;
    color: var(--color-blue);
    text-align: center;
    min-height: 4rem;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: var(--space-sm);
  }

  .card-short {
    font-size: 1rem;
    font-weight: 400;
    color: var(--color-text-dark);
    margin-bottom: var(--space-sm);
    text-align: center;
  }

  .card-full {
    font-size: 0.95rem;
    color: var(--color-text-muted);
    line-height: 1.6;
    max-height: 0;
    opacity: 0;
    overflow: hidden;
    transition: all 0.4s ease;
    margin-bottom: 0;
  }

  .card-link {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: var(--color-blue);
    font-size: 0.9rem;
    font-weight: 500;
    margin-top: 0;
    opacity: 0;
    transform: translateX(-10px);
    max-height: 0;
    overflow: hidden;
    transition: all 0.4s ease;
  }

  .card-link svg {
    transition: transform 0.3s ease;
  }

  .card-cta {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    color: inherit;
    text-decoration: none;
  }

  /* Hover effects */
  .value-card:hover {
    transform: translateY(-8px);
    box-shadow: 0 16px 40px -10px rgba(36, 121, 190, 0.3);
  }

  .value-card:hover .card-icon {
    transform: scale(1.1);
  }

  .value-card:hover .card-full {
    max-height: 200px;
    opacity: 1;
    margin-bottom: var(--space-sm);
  }

  .value-card:hover .card-link {
    opacity: 1;
    transform: translateX(0);
    max-height: 40px;
    margin-top: var(--space-sm);
  }

  .value-card:hover .card-link svg {
    transform: translateX(4px);
  }

  /* Expanded (mobile tap) state */
  .value-card.expanded .card-full {
    max-height: 200px;
    opacity: 1;
    margin-bottom: var(--space-sm);
  }

  .value-card.expanded .card-link {
    opacity: 1;
    transform: translateX(0);
    max-height: 40px;
    margin-top: var(--space-sm);
  }

  /* Values CTA Section */
  .values-button-wrapper {
    margin-top: var(--section-cta-gap);
  }

  .value-cta-button {
    gap: 0.5rem;
  }

  @media (max-width: 768px) {
    .cards-grid {
      grid-template-columns: 1fr;
      gap: var(--space-sm);
    }

    .value-prop-headline {
      font-size: var(--font-size-h4);
    }

    /* Show full text on mobile without hover */
    //.card-full {
    //  max-height: none;
    //  opacity: 1;
    //  margin-bottom: var(--space-sm);
    //}

    .card-link {
      opacity: 1;
      transform: translateX(0);
    }

  }
</style>
