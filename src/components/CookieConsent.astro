---
import 'vanilla-cookieconsent/dist/cookieconsent.css';

interface Props {
  lang: 'de' | 'en';
  gaId: string;
}

const { lang, gaId } = Astro.props;
---

<div id="cc-container" data-lang={lang} data-ga-id={gaId}></div>

<!-- Google Consent Mode v2: Load gtag.js immediately with default denied consent -->
<!-- This allows Google to detect the tag while respecting GDPR -->
<script is:inline define:vars={{ gaId }}>
  // Initialize dataLayer and gtag immediately
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  // Make gtag globally available
  window.gtag = gtag;

  // Set default consent to denied (GDPR compliant)
  gtag('consent', 'default', {
    'ad_storage': 'denied',
    'ad_user_data': 'denied',
    'ad_personalization': 'denied',
    'analytics_storage': 'denied',
    'wait_for_update': 500
  });

  // Initialize GA4 (won't collect data until consent is granted)
  gtag('js', new Date());
  gtag('config', gaId, { anonymize_ip: true });

  // Store gaId for the gtag script to load
  window.__GA4_ID = gaId;
</script>
<script is:inline>
  // Load gtag.js script dynamically
  (function() {
    var s = document.createElement('script');
    s.async = true;
    s.src = 'https://www.googletagmanager.com/gtag/js?id=' + window.__GA4_ID;
    document.head.appendChild(s);
  })();
</script>

<script>
  import { run } from 'vanilla-cookieconsent';
  import { createConfig } from './CookieConsentConfig';

  const container = document.getElementById('cc-container');
  if (!container) throw new Error('Cookie consent container not found');
  
  const lang = container.dataset.lang as 'de' | 'en';

  let hasShownBanner = false;

  // Update Google Consent Mode when user accepts analytics
  const updateGoogleConsent = () => {
    if ((window as any).__consentUpdated) return;
    (window as any).__consentUpdated = true;

    (window as any).gtag('consent', 'update', {
      'analytics_storage': 'granted'
    });
  };

  const config = createConfig(lang, updateGoogleConsent);
  run(config);

  // Hide banner initially, show on scroll (after 60px)
  const hideBanner = () => {
    const modal = document.querySelector('#cc-main .cm');
    if (modal && !hasShownBanner && !(window as any).CookieConsent?.validConsent()) {
      modal.classList.add('cc-hidden');
    }
  };

  const showBanner = () => {
    const modal = document.querySelector('#cc-main .cm');
    if (modal && !hasShownBanner) {
      modal.classList.remove('cc-hidden');
      hasShownBanner = true;
    }
  };

  // Wait for modal to be rendered, then hide it
  setTimeout(hideBanner, 100);

  // Show banner when scrolling past 60px
  const handleScroll = () => {
    if (window.scrollY > 60 && !hasShownBanner && !(window as any).CookieConsent?.validConsent()) {
      showBanner();
      window.removeEventListener('scroll', handleScroll);
    }
  };

  window.addEventListener('scroll', handleScroll);

  // Observe for when the modal is added to DOM
  const observer = new MutationObserver(() => {
    const modal = document.querySelector('#cc-main .cm');
    if (modal && !hasShownBanner && !(window as any).CookieConsent?.validConsent()) {
      if (window.scrollY <= 60) {
        modal.classList.add('cc-hidden');
      }
    }
  });

  observer.observe(document.body, { childList: true, subtree: true });
</script>

