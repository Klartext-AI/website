---
import 'vanilla-cookieconsent/dist/cookieconsent.css';

interface Props {
  lang: 'de' | 'en';
  gaId: string;
}

const { lang, gaId } = Astro.props;
---

<div id="cc-container" data-lang={lang} data-ga-id={gaId}></div>

<script>
  import * as CookieConsent from 'vanilla-cookieconsent';
  import { createConfig } from './CookieConsentConfig';

  // Extend window for TypeScript
  declare global {
    interface Window {
      dataLayer: any[];
      gtag: (...args: any[]) => void;
    }
  }

  const container = document.getElementById('cc-container');
  if (!container) throw new Error('Cookie consent container not found');
  
  const lang = container.dataset.lang as 'de' | 'en';
  const gaId = container.dataset.gaId!;

  // 1. Initialize dataLayer and gtag function
  window.dataLayer = window.dataLayer || [];
  window.gtag = function gtag() {
    window.dataLayer.push(arguments);
  };

  // 2. Set default consent to DENIED before loading gtag.js
  // This ensures no data is collected until user consents
  window.gtag('consent', 'default', {
    analytics_storage: 'denied',
    ad_storage: 'denied',
    ad_user_data: 'denied',
    ad_personalization: 'denied',
  });

  // 3. Load gtag.js immediately (with consent denied, no data sent yet)
  (function loadGtagScript() {
    if (document.querySelector('script[data-gtag="true"]')) return;

    const s = document.createElement('script');
    s.async = true;
    s.src = `https://www.googletagmanager.com/gtag/js?id=${encodeURIComponent(gaId)}`;
    s.dataset.gtag = 'true';
    document.head.appendChild(s);
  })();

  // 4. Initialize GA4 (won't collect data until consent is granted)
  window.gtag('js', new Date());
  window.gtag('config', gaId, { anonymize_ip: true });

  // 5. Handler called on consent events - updates consent state
  function updateFromCookieConsent() {
    const analyticsGranted = CookieConsent.acceptedCategory('analytics');

    // Update Google's consent state
    window.gtag('consent', 'update', {
      analytics_storage: analyticsGranted ? 'granted' : 'denied',
    });
  }

  // Run CookieConsent with callbacks
  const config = createConfig(lang, updateFromCookieConsent);
  CookieConsent.run(config);

  // --- Banner visibility control (show after scroll) ---
  let hasShownBanner = false;

  const hideBanner = () => {
    const modal = document.querySelector('#cc-main .cm');
    if (modal && !hasShownBanner && !CookieConsent.validConsent()) {
      modal.classList.add('cc-hidden');
    }
  };

  const showBanner = () => {
    const modal = document.querySelector('#cc-main .cm');
    if (modal && !hasShownBanner) {
      modal.classList.remove('cc-hidden');
      hasShownBanner = true;
    }
  };

  // Wait for modal to be rendered, then hide it
  setTimeout(hideBanner, 100);

  // Show banner when scrolling past 60px
  const handleScroll = () => {
    if (window.scrollY > 60 && !hasShownBanner && !CookieConsent.validConsent()) {
      showBanner();
      window.removeEventListener('scroll', handleScroll);
    }
  };

  window.addEventListener('scroll', handleScroll);

  // Observe for when the modal is added to DOM
  const observer = new MutationObserver(() => {
    const modal = document.querySelector('#cc-main .cm');
    if (modal && !hasShownBanner && !CookieConsent.validConsent()) {
      if (window.scrollY <= 60) {
        modal.classList.add('cc-hidden');
      }
    }
  });

  observer.observe(document.body, { childList: true, subtree: true });
</script>

